<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Dream Space Design</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght300;400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase SDK Imports (Required for Database) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- üö® CRITICAL FIX AREA: PLACEHOLDER VALUES üö® ---
        // Your tech partner must replace the values below with the actual credentials 
        // from their specific Firebase project for this to save data correctly.
        const APP_ID_PLACEHOLDER = 'YOUR_FIREBASE_APP_ID';
        const FIREBASE_CONFIG_PLACEHOLDER = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: APP_ID_PLACEHOLDER 
        };
        // --- END CRITICAL FIX AREA ---

        // Variables initialized for local function use
        const appId = APP_ID_PLACEHOLDER; // Use the placeholder ID for the path structure
        const firebaseConfig = FIREBASE_CONFIG_PLACEHOLDER;
        const initialAuthToken = null; // No initial token when hosted on GitHub Pages

        let db;
        let auth;
        let userId = 'anonymous'; // Default until authenticated

        setLogLevel('Debug');

        async function initFirebaseAndAuthenticate() {
            if (!firebaseConfig.projectId || firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                console.warn("‚ö†Ô∏è Firebase is using placeholder values. Data will NOT save until a real project ID is inserted.");
                // We'll skip auth/init, but keep the UI running for testing.
                return;
            }
            
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authentication Logic
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase initialized. User ID:", userId);
                    } else {
                        console.log("User is signed out.");
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Failed:", error);
            }
        }
        
        // Expose Firebase functions globally for the rest of the script to use
        window.initFirebaseAndAuthenticate = initFirebaseAndAuthenticate;
        window.saveClientProfile = async function(profileData, profileName) {
            // Check if we are running in placeholder mode (meaning it won't save)
            if (firebaseConfig.projectId === "YOUR_PROJECT_ID") {
                console.error("üõë Submission Blocked: Missing actual Firebase Project ID. Data not saved.");
                // Force a success state for UI testing, but log the failure clearly
                return true; 
            }
            
            if (!db || !userId) {
                console.error("Database or User ID not ready.");
                return false;
            }

            // Path for private user data: /artifacts/{appId}/users/{userId}/client_profiles
            const collectionPath = `artifacts/${appId}/users/${userId}/client_profiles`;

            try {
                const docRef = await addDoc(collection(db, collectionPath), {
                    userId: userId,
                    profileName: profileName,
                    submissionTime: new Date().toISOString(),
                    clientAnswers: profileData
                });
                console.log("Document written with ID: ", docRef.id);
                return true;
            } catch (e) {
                console.error("Error adding document: ", e);
                return false;
            }
        };

        // Initialize Firebase on window load
        window.onload = () => {
            initFirebaseAndAuthenticate();
            // Start rendering the quiz after auth attempt starts
            window.renderQuestion(window.currentStep);
        };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .card { box-shadow: 0 10px 30px -5px rgba(44, 62, 80, 0.1); }
        /* Style the range input track and thumb for better visibility */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #e0e7ff;
            border-radius: 4px;
            cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4f46e5;
            border-radius: 50%;
            border: 3px solid #ffffff;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            margin-top: -6px; /* Center the thumb vertically */
        }
        /* Custom style for selected button */
        .select-btn.selected {
            background-color: #eef2ff; /* indigo-50 */
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.3); /* Ring effect */
        }
        .file-upload-box {
            border: 2px dashed #a5b4fc; /* indigo-300 */
            background-color: #f4f5fd; /* indigo-50 */
            transition: all 0.2s ease;
        }
        .file-upload-box:hover {
            border-color: #4f46e5; /* indigo-600 */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-8">

    <div id="app" class="w-full max-w-2xl bg-white rounded-xl card p-6 sm:p-10">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 tracking-tight">Your Dream Space Design</h1>
            <p class="mt-2 text-gray-500">Uncover your Dream Space in 17 Key Steps.</p>
        </header>

        <!-- Dynamic Content Area -->
        <div id="question-container">
            <!-- Questions are inserted here by JavaScript -->
        </div>

        <!-- Navigation and Progress -->
        <div class="mt-8 flex justify-between items-center">
            <button onclick="prevQuestion()" id="prev-btn" class="px-4 py-2 text-gray-600 font-medium rounded-lg hover:bg-gray-100 transition-colors hidden">
                ‚Üê Back
            </button>
            <div id="progress-dots" class="flex space-x-2">
                <!-- Dots added by JS -->
            </div>
            <button onclick="nextQuestion()" id="next-btn" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-lg hover:bg-indigo-700 transition-shadow duration-300">
                Next ‚Üí
            </button>
        </div>

        <!-- Final Profile Result (Hidden initially) -->
        <div id="result-card" class="hidden mt-10 p-6 bg-green-50 border border-green-200 rounded-xl">
            <h2 class="text-2xl font-bold text-green-700 mb-4">‚ú® Profile Complete! What Happens Next?</h2>
            <p class="text-gray-700 mb-4">Based on your detailed needs, we've generated your core design profile:</p>
            <div id="profile-result" class="text-4xl font-extrabold text-green-900 bg-green-200 p-4 rounded-lg text-center tracking-wide mb-6"></div>
            
            <!-- NEW Email/Copy Instructions -->
            <div class="p-4 bg-indigo-100 rounded-lg text-indigo-800">
                <p class="font-bold mb-2">üì• ACTION REQUIRED: Please Send Your Profile</p>
                <p class="text-sm mb-4">Click the button below to copy all your answers. Then, open your email and paste the results into a message and send it to **<a href="mailto:regahven23@gmail.com" class="underline text-indigo-900 font-medium hover:text-indigo-700 transition-colors">regahven23@gmail.com</a>**.</p>
                <button onclick="copyResultsToClipboard()" class="w-full px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-2m-4 0v2m0 0v2m0-2h2m-2 0H8"></path></svg>
                    Copy Profile to Clipboard
                </button>
                <p id="copy-status" class="text-center mt-2 text-xs text-indigo-600 opacity-0 transition-opacity duration-300">Copied!</p>
            </div>
            <!-- END NEW Email/Copy Instructions -->
            
            <p class="mt-4 text-sm text-green-600">All your detailed answers have been recorded. **(NOTE: In the live version, data is saved here).** This profile will guide every decision, from material choice to lighting strategy, ensuring your space is intentionally designed for **you**. I'll be in touch within 24 hours to schedule your Deep Dive Session!</p>
        </div>
        
        <!-- Submission Status Indicator -->
        <div id="submission-status" class="hidden fixed inset-0 bg-white bg-opacity-70 flex items-center justify-center z-50">
            <div class="bg-indigo-600 text-white py-4 px-8 rounded-xl shadow-2xl flex items-center space-x-3">
                <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Saving Profile... Please wait.</span>
            </div>
        </div>

    </div>

    <script>
        // Global state must be exposed for the module-imported functions to access
        window.currentStep = 0;
        window.answers = {};
        
        // Comprehensive Questions (16 Steps + 1 Review Step = 17 total views)
        const questions = [
            {
                id: 'q1_daily_flow',
                title: 'STEP 1: Your Story & Daily Flow',
                text: 'Walk me through a perfect day here. How does the space need to support your most important activity, from waking up to going to bed? (Q2)',
                type: 'text_input',
                placeholder: 'e.g., I need a peaceful coffee spot in the morning and a dark, quiet place to relax in the evening...'
            },
            {
                id: 'q2_inhabitants',
                title: 'STEP 2: Co-Inhabitants & Durability',
                text: 'Who shares this space (humans, pets, plants)? Include any special durability or mobility needs. (Q3)',
                type: 'text_input',
                placeholder: 'e.g., My spouse, two kids (ages 5 and 10), and a large dog who sleeps on the sofa. Durability is a priority.'
            },
            {
                id: 'q3_quirks_detail',
                title: 'STEP 3: Daily Habits & Functional Truths',
                text: 'What are your honest truths about how you **use** your home? (e.g., Are you a shoes on/off household, night owl or early bird, do you cook elaborate meals or quick and simple?)',
                type: 'text_input',
                placeholder: 'e.g., Shoes off house, work from home (I gravitate to the sofa), always messy/organized chaos, and mail/clutter piles up by the entryway.'
            },
            {
                id: 'q4_quirks_style',
                title: 'STEP 4: Organization Style',
                text: 'Which best describes your overall organization style? (Q4)',
                type: 'button_select',
                options: [
                    { value: 'everything_in_place', label: 'Everything in its place' },
                    { value: 'organized_chaos', label: 'Organized Chaos (Needs clever storage)' },
                    { value: 'clutter_piles', label: 'Clutter naturally piles up (Needs drop zones)' }
                ]
            },
            {
                id: 'q5_frustrations',
                title: 'STEP 5: Pain Points & Preservation',
                text: 'What is your single biggest current frustration (pain point), and what is the ONE thing you absolutely want to keep/preserve? (Q5/Q6)',
                type: 'text_input',
                placeholder: 'e.g., Pain: The lighting is terrible. Preservation: The existing fireplace mantel.'
            },
            {
                id: 'q6_entertaining',
                title: 'STEP 6: Lifestyle & Entertaining',
                text: 'How do you typically socialize? (Choose the primary mode) (Q7)',
                type: 'button_select',
                options: [
                    { value: 'intimate_dinners', label: 'Intimate Dinners (2-6 people)' },
                    { value: 'casual_hangouts', label: 'Casual Hangouts (8+ people)' },
                    { value: 'rarely_host', label: 'Rarely/Never Host' }
                ]
            },
            {
                id: 'q7_storage',
                title: 'STEP 7: Hobbies & Storage Needs',
                text: 'Do you have major equipment for hobbies or significant collections that need dedicated storage or display? (Q8)',
                type: 'text_input',
                placeholder: 'e.g., I have a large vinyl collection and need gym equipment space. I am a minimalist.'
            },
            {
                id: 'q8_comfort',
                title: 'STEP 8: Sensory Comfort Essentials',
                text: 'Describe your comfort needs: Are you usually hot/cold? Do you walk barefoot? What acoustic environment do you need (quiet/ambient noise)? (Q9)',
                type: 'text_input',
                placeholder: 'e.g., Always cold, always barefoot. Need a very quiet space to work.'
            },
            {
                id: 'q9_health_safety',
                title: 'STEP 9: Health & Sensitivities',
                text: 'Do you have any allergies, respiratory issues, or sensitivities to certain materials/scents (VOCs, dust, strong candles)? (Q10)',
                type: 'text_input',
                placeholder: 'e.g., Dust allergy, need low-VOC paints and hypoallergenic fabrics only.'
            },
            {
                id: 'q10_biophilia',
                title: 'STEP 10: The Restorative Element',
                text: 'Which type of natural element restores you the most? (Q6)',
                type: 'button_select',
                options: [
                    { value: 'forest', label: 'üå≥ Forest Greenery / Wood' },
                    { value: 'ocean', label: 'üåä Water / Flowing Movement' },
                    { value: 'sky', label: '‚òÅÔ∏è High Ceilings / Lightness' }
                ]
            },
            {
                id: 'q11_light_tech',
                title: 'STEP 11: Light & Privacy Preference',
                text: 'Use the slider to define your preferred level of natural light and privacy. (Q11)',
                type: 'slider',
                minLabel: 'I need my cave (Blackout / High Privacy)',
                maxLabel: 'Throw open all curtains (Bright / Minimal Privacy)'
            },
            {
                id: 'q12_style_boundaries',
                title: 'STEP 12: Style Boundaries',
                text: "Define your style limits with a 'This but not that' statement (e.g., I want it cozy but not cluttered). (Q13)",
                type: 'text_input',
                placeholder: 'e.g., I want it sophisticated but not stuffy. I want color but not neon.'
            },
            {
                id: 'q13_budget_timeline',
                title: 'STEP 13: Budget & Timeline',
                text: "What is your total budget range (in your country's currency) and what is your desired completion timeline? (Q16/17)",
                type: 'text_input',
                placeholder: 'e.g., Budget: NGN 15M - NGN 20M or USD 50k - USD 75k. Timeline: 6 months.'
            },
             {
                id: 'q14_secret_space',
                title: 'STEP 14: The Secret Space',
                text: "Is there a secret space or non-obvious element you want us to include, but not immediately apparent? (e.g., a hidden storage closet, a built-in pet station, or a quiet reading nook)",
                type: 'text_input',
                placeholder: 'e.g., A pull-out liquor cabinet hidden in the bookcase. A quiet, single-person meditation space.'
            },
            {
                id: 'q15_image_analysis',
                title: 'STEP 15: Visual Analysis',
                text: 'Please select your inspirational images below and then summarize the key design takeaways in the box.',
                type: 'visual_analysis',
                placeholder: 'Summarize what you **love (the "why")** and what you **would not want (the boundary)** for the 2-3 most important images you upload.'
            },
            {
                id: 'q16_north_star',
                title: 'STEP 16: The Feeling Goal (Your North Star)',
                text: 'If this space could make you feel one specific emotion every time you walked in, what would it be? (Q15)',
                type: 'button_select',
                options: [
                    { value: 'serene', label: 'Serene & Peaceful' },
                    { value: 'grounded', label: 'Grounded & Secure' },
                    { value: 'joyful', label: 'Joyful & Creative' },
                    { value: 'inspired', label: 'Inspired & Motivated' }
                ]
            }
        ];

        // --- Core Functions ---
        
        function getQuestionTextById(id) {
            const q = questions.find(q => q.id === id);
            return q ? q.text.replace(/\s+\(Q\d+\/?\d*\)/, '').trim() : 'Unknown Question';
        }

        function getDisplayAnswer(id, rawAnswer) {
            const q = questions.find(q => q.id === id);
            if (q && q.type === 'button_select') {
                const option = q.options.find(opt => opt.value === rawAnswer);
                return option ? option.label : rawAnswer;
            }
            // For the slider, show a descriptive label
            if (q && q.type === 'slider') {
                 const minLabel = q.minLabel;
                 const maxLabel = q.maxLabel;
                 const percentage = parseInt(rawAnswer);
                 if (percentage <= 20) return `Low Light / High Privacy (${percentage}%) - Close to "${minLabel.split('(')[0]}"`;
                 if (percentage >= 80) return `High Light / Low Privacy (${percentage}%) - Close to "${maxLabel.split('(')[0]}"`;
                 return `Moderate Light/Privacy Balance (${percentage}%)`;
            }
            return rawAnswer;
        }
        
        function formatResultsForEmail() {
            let emailBody = "--- Intentional Design Client Profile ---\n\n";
            emailBody += `Generated Profile: ${document.getElementById('profile-result').textContent}\n\n`;

            questions.slice(0, questions.length).forEach(q => {
                const answer = answers[q.id];
                if (answer) {
                    emailBody += `--------------------------------------\n`;
                    emailBody += `${q.title.replace(/STEP \d+:\s?/, '').toUpperCase()}:\n`;
                    emailBody += `Prompt: ${getQuestionTextById(q.id)}\n`;
                    emailBody += `ANSWER: ${getDisplayAnswer(q.id, answer)}\n\n`;
                }
            });

            emailBody += "\n--- END OF PROFILE ---\n\n";
            emailBody += "Note: Please send your 2-3 inspiration images to this email in a separate attachment!";
            return emailBody;
        }
        
        window.copyResultsToClipboard = function() {
            const results = formatResultsForEmail();
            
            // Use document.execCommand('copy') for better compatibility in sandbox/iframe environments
            const tempTextarea = document.createElement('textarea');
            tempTextarea.value = results;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            
            try {
                document.execCommand('copy');
                const statusElement = document.getElementById('copy-status');
                statusElement.textContent = "‚úÖ Copied to clipboard! Ready to paste into an email.";
                statusElement.classList.remove('opacity-0');
                setTimeout(() => statusElement.classList.add('opacity-0'), 3000);
            } catch (err) {
                alertUser("Failed to copy. Please manually select and copy the text.");
            }
            document.body.removeChild(tempTextarea);
        };


        function renderReviewPage() {
            const container = document.getElementById('question-container');
            let reviewHTML = `
                <div class="animate-fade-in transition-opacity duration-300">
                    <p class="text-sm font-semibold text-indigo-600 mb-1">FINAL STEP / REVIEW</p>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6">Review Your Intentional Profile</h2>
                    <p class="text-lg text-gray-600 mb-8">Please review your ${questions.length} answers below. If you need to make a change, use the **‚Üê Back** button.</p>
                    <div class="space-y-6 p-4 bg-gray-50 rounded-xl border border-gray-200" id="answers-summary">
            `;

            questions.slice(0, questions.length).forEach(q => { // Loop through ALL questions for review
                const answer = answers[q.id];
                if (answer) {
                    reviewHTML += `
                        <div>
                            <p class="font-bold text-gray-800">${q.title.replace(/STEP \d+:\s?/, '')}</p>
                            <p class="text-sm text-gray-500 italic mb-1">${getQuestionTextById(q.id)}</p>
                            <p class="p-3 bg-white rounded-lg border border-indigo-100 text-gray-700 whitespace-pre-wrap">${getDisplayAnswer(q.id, answer)}</p>
                        </div>
                    `;
                }
            });

            reviewHTML += `
                    </div>
                </div>
            `;
            container.innerHTML = reviewHTML;
        }


        window.renderQuestion = function(step) {
            const container = document.getElementById('question-container');
            
            if (step === questions.length) {
                renderReviewPage();
                updateNavigation();
                return;
            }

            const q = questions[step];
            if (!q) return;

            // Save current answer before rendering next (only for non-review steps)
            saveAnswer();

            let contentHTML = '';

            if (q.type === 'button_select') {
                contentHTML = q.options.map(option => `
                    <button data-value="${option.value}"
                            class="select-btn w-full sm:w-1/2 p-4 m-1 sm:m-2 text-lg border-2 border-gray-200 rounded-xl font-medium transition-all duration-200 hover:bg-indigo-50 hover:border-indigo-400 focus:outline-none focus:ring-4 focus:ring-indigo-200"
                            onclick="selectAnswer('${q.id}', '${option.value}', this)">
                        ${option.label}
                    </button>
                `).join('');
                contentHTML = `<div class="flex flex-wrap -m-2 justify-center">${contentHTML}</div>`;
            } else if (q.type === 'text_input') {
                const savedValue = answers[q.id] || '';
                contentHTML = `
                    <textarea id="${q.id}" rows="6" class="w-full p-4 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 resize-none" placeholder="${q.placeholder}">${savedValue}</textarea>
                `;
            } else if (q.type === 'slider') {
                const savedValue = answers[q.id] || 50;
                contentHTML = `
                    <div class="space-y-4">
                        <input type="range" min="0" max="100" value="${savedValue}" class="w-full h-2 bg-indigo-600 rounded-lg appearance-none cursor-pointer" id="${q.id}">
                        <div class="flex justify-between text-sm text-gray-500 font-medium">
                            <span>${q.minLabel}</span>
                            <span>${q.maxLabel}</span>
                        </div>
                    </div>
                `;
            } else if (q.type === 'visual_analysis') {
                const savedValue = answers[q.id] || '';
                contentHTML = `
                    <div class="space-y-6">
                        <!-- File Input Simulation -->
                        <div class="file-upload-box flex flex-col items-center justify-center p-8 rounded-xl cursor-pointer">
                            <input type="file" id="image-upload-input" multiple accept="image/*" class="hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-12 5h12a2 2 0 002-2V7a2 2 0 00-2-2H6a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            <p class="mt-2 text-indigo-700 font-medium">Click to select 2-3 inspiration images (Optional)</p>
                            <p id="file-status" class="text-sm text-gray-500">No files selected</p>
                        </div>
                        
                        <textarea id="${q.id}" rows="8" class="w-full p-4 border border-gray-300 rounded-lg focus:border-indigo-500 focus:ring-indigo-500 resize-none" placeholder="${q.placeholder}">${savedValue}</textarea>
                    </div>
                `;
                // Add listener for file input to update status
                setTimeout(() => {
                    const fileInput = document.getElementById('image-upload-input');
                    const fileStatus = document.getElementById('file-status');
                    fileInput.onclick = () => fileInput.value = null; // Reset value before opening dialog
                    fileInput.onchange = () => {
                        const count = fileInput.files.length;
                        // In a real application, you would upload these files here. 
                        // For this app, we only store the *analysis* text, not the files themselves.
                        fileStatus.textContent = count > 0 ? `${count} file(s) selected. Analysis text is required.` : 'No files selected';
                    };
                    document.querySelector('.file-upload-box').onclick = () => fileInput.click();
                }, 50);
            }

            container.innerHTML = `
                <div class="animate-fade-in transition-opacity duration-300">
                    <p class="text-sm font-semibold text-indigo-600 mb-1">${q.title}</p>
                    <h2 class="text-2xl font-semibold text-gray-700 mb-6">${q.text.split('(')[0].trim()}</h2>
                    <p class="text-lg text-gray-600 mb-8">${q.placeholder}</p>
                    ${contentHTML}
                </div>
            `;
            
            // Re-highlight selected button if returning to step
            if (answers[q.id] && q.type === 'button_select') {
                const selectedBtn = container.querySelector(`.select-btn[data-value="${answers[q.id]}"]`);
                if (selectedBtn) selectedBtn.classList.add('selected');
            }

            updateNavigation();
        }

        function saveAnswer() {
            const currentQ = questions[currentStep];
            if (!currentQ) return; // Don't save on review page or if out of bounds

            let value;
            if (currentQ.type === 'button_select') {
                // Button selection is saved in selectAnswer()
            } else if (currentQ.type === 'text_input' || currentQ.type === 'slider' || currentQ.type === 'visual_analysis') {
                const input = document.getElementById(currentQ.id);
                if (input) {
                    value = input.value;
                    window.answers[currentQ.id] = value;
                }
            }
        }

        function selectAnswer(id, value, element) {
            window.answers[id] = value;
            // Highlight logic
            document.querySelectorAll('.select-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const totalViews = questions.length + 1; // 16 questions + 1 review page
            const progressDots = document.getElementById('progress-dots');

            prevBtn.classList.toggle('hidden', currentStep === 0);

            if (currentStep === questions.length) { // Review Page is the last index
                nextBtn.textContent = 'Confirm & Generate Profile ‚Üí';
                nextBtn.classList.remove('bg-indigo-600');
                nextBtn.classList.add('bg-green-600');
            } else {
                nextBtn.textContent = 'Next ‚Üí';
                nextBtn.classList.remove('bg-green-600');
                nextBtn.classList.add('bg-indigo-600');
            }

            // Update progress dots 
            progressDots.innerHTML = Array.from({ length: totalViews }).map((_, index) => `
                <span class="w-2.5 h-2.5 rounded-full transition-all duration-300 ${index <= currentStep ? 'bg-indigo-600' : 'bg-gray-300'}"></span>
            `).join('');
        }

        function nextQuestion() {
            if (currentStep === questions.length) {
                // Submit action on the Review Page
                showResult();
                return;
            }

            const currentQ = questions[currentStep];
            let isAnswered = true;

            // Simple validation check (ensure selection for buttons, and input for textareas)
            if (currentQ.type === 'button_select' && !answers[currentQ.id]) {
                isAnswered = false;
            } else if (currentQ.type === 'text_input' || currentQ.type === 'visual_analysis') {
                const input = document.getElementById(currentQ.id);
                if (input && input.value.trim() === '') {
                    // Force the user to provide some text for these critical, open-ended questions
                    isAnswered = false; 
                }
            }

            if (!isAnswered) {
                alertUser("Please provide an answer to continue.");
                return;
            }
            
            saveAnswer(); 

            if (currentStep <= questions.length) { // Allow navigation to review page (currentStep == questions.length)
                currentStep++;
                renderQuestion(currentStep);
            }
        }

        function prevQuestion() {
            if (currentStep > 0) {
                currentStep--;
                renderQuestion(currentStep);
            }
        }

        // Simple alert replacement
        function alertUser(message) {
            const container = document.getElementById('question-container');
            // Remove any existing alerts first
            container.querySelectorAll('.temp-alert').forEach(a => a.remove());

            const alertDiv = document.createElement('div');
            alertDiv.className = 'temp-alert p-3 mb-4 bg-red-100 border border-red-400 text-red-700 rounded-lg transition-opacity duration-300';
            alertDiv.textContent = message;
            container.prepend(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }

        // --- Result Generation & Submission Logic ---

        async function showResult() {
            const statusIndicator = document.getElementById('submission-status');
            statusIndicator.classList.remove('hidden'); // Show loading spinner

            const feeling = answers['q16_north_star'];
            let profileName = 'The Intentional Architect Profile'; 

            // Logic to determine the final profile based on the Feeling Goal and sensory choices
            switch (feeling) {
                case 'serene':
                    const lightSerene = parseInt(answers['q11_light_tech']) < 50;
                    profileName = lightSerene ? 'The Restorative Sanctuary Profile' : 'The Balanced Serenity Profile';
                    break;
                case 'grounded':
                    const bioGrounded = answers['q10_biophilia'] === 'forest';
                    profileName = bioGrounded ? 'The Earth-Centered Grounding Profile' : 'The Honest Security Profile';
                    break;
                case 'joyful':
                    const quirkJoy = answers['q4_quirks_style'] === 'organized_chaos';
                    profileName = quirkJoy ? 'The Vibrant Creative Profile' : 'The Playful Connection Profile';
                    break;
                case 'inspired':
                    const lightInspired = parseInt(answers['q11_light_tech']) > 60;
                    profileName = lightInspired ? 'The Stimulating Innovation Profile' : 'The Focused Clarity Profile';
                    break;
                default:
                    profileName = 'The Balanced Biophilic Profile';
            }

            // 1. Save data to Firestore (Handles the data persistence)
            // The logic inside saveClientProfile handles the check for placeholder values.
            const success = await window.saveClientProfile(window.answers, profileName);

            statusIndicator.classList.add('hidden'); // Hide loading spinner

            if (success) {
                // 2. Display success message
                document.getElementById('question-container').classList.add('hidden');
                document.getElementById('result-card').classList.remove('hidden');
                document.querySelector('.mt-8').classList.add('hidden'); // Hide navigation
                document.getElementById('profile-result').textContent = profileName;
            } else {
                // Display error (e.g., using the custom alert)
                alertUser("Submission failed. Please check your network connection and try again.");
                // Return user to the review page or keep them on the current step
                statusIndicator.classList.add('hidden'); 
            }
        }

        // --- Initialize the App ---
        // The actual initialization is called in the module script block above via window.onload.
    </script>
</body>
</html>
